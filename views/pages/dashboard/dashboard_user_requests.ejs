<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link rel="stylesheet" href="/assets/dashboard_orders.css">
	<title>Order Page</title>
</head>
<body>
	<!-- SIDEBAR -->
    <%- include ('dashboard_sidebar') -%>
    
	<section id="content">
		<nav>
			<i class='bx bx-menu toggle-sidebar' ></i>
			<form action="#">
				<div class="form-group">
				</div>
			</form>
			
		</nav>
		<div class="dash-content">
            <div class="overview">
                <div class="title">
			<h1 class="title">Your Pending Requests</h1>
			</div>
		<div class="boxes"  style="overflow-x:auto;">
      <table class="table table-bordered">

        <% if(result.length == 0) { %>
          <h2 style="text-align:center">You have no pending rental requests.</h2>
        <% }else if(result) { %>

        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Owner</th>
            <th scope="col">Item Name</th>
            <th scope="col">Rental Date</th>
            <th scope="col">Return Date</th>
            <th scope="col">Quantity</th>
            <th scope="col">Total Amount</th>
            <th scope="col">Payment</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <% result.forEach(function(rental){ %>
            <tr>
              <td id="id"><%= rental.reservation_id %> <br> <a href="/rental/view/<%= rental.reservation_id %>">View Rental Details</a> </td>
              <td id="owner"><%= rental.owner_id %></td>
              <td id="itemName"> <a href="/items/view/<%= rental.item_id%>"><%= rental.item_name %></a></td>
              <td id="rentalDate"><%= rental.reservation_start.toDateString() %></td>
              <td id="returnDate"><%= rental.reservation_end.toDateString() %></td>
              <td id="qty"><%= rental.quantity %></td>
              <td id="totalAmount"><%= rental.total_amount.toFixed(2) %></td>
              <% if(rental.mode_of_payment == 2 ){%>
              <td id="modePayment">Gcash<br> </td>              
              <td id="status">Your rental request is still pending. Payment awaiting by the lessor.                                   
                  <br><br><button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#GModal" onClick="showModal(<%= rental.reservation_id %>,`<%= rental.reservation_start.toDateString() %>`, `<%= rental.reservation_end.toDateString() %>`, `<%= rental.item_name %>`, `<%=rental.quantity %>`, `<%=rental.rental_rate %>`, `<%=rental.replacement_cost %>`, `<%=rental.total_amount %>`)">Gcash Payment</button><br></td>
              <% } else if (rental.mode_of_payment == 3 ){%>
              <td id="modePayment">Cash On Delivery<br> </td>              
              <td id="status">Your rental request is still pending. Please wait for <br> it to be accepted by the lessor.</td>              
              <%}%>
            </tr>
          <% }) %>  
        </tbody>
      </table>
		</div>
	</section>

        <% } %>

 <form action="/dashboard/user/requests" method="post">
<!-- Modal -->
        <div class="modal fade" id="GModal" role="dialog">
        <div class="modal-dialog">
<!-- Modal content-->
            <div class="modal-content" style= "width: 750px; ">
              <div class="modal-header" style ="background-color: #33cccc; color: white;">
                  <h4 class="modal-title" style ="background-color: #33cccc; color: white;">Payment Confirmation</h4>
                <span class="close" data-dismiss="modal" style = " color: white;" >&times;</span>
              </div>
              <div class="modal-body" style="background-color: white;">

                    <div class="container" style="color: black; width: 650px; height: auto; background-color: white; font-family: 'Poppins'; font-size: medium;" >
                        <div class="p-5 my-4 bg-white rounded-3">
                            <img src="/images/GCash-Logo.png" style="width: 200px; height:120px;">
                            <p><strong>Name: </strong>  <br>
                                <strong>Contact no.:  </strong><br>
                                <hr>
                                <strong>Reservation Start: <span id="gResStart"></strong></span><br>
                                <strong >Reservation End:  <span id="gResEnd"></span></strong><br>
                                <strong >Item Name:<span id="gItemName"></span></strong> <br>
                                <strong >Quantity</strong> <span id="gQuantity"></span> <br>
                                <strong>Rental Fee:</strong> ₱<span id="gRental"></span><br>
                                <strong>Deposit Fee:</strong> ₱<span id="gReplacement"></span> <br>
                                <br>
                                <strong>Total:</strong> ₱<span id="gTotal"></span><br>
                                <hr>
                                <h4>Proof of Payment</h4>
                                
                            <div style="width: 400px;">
                            <label for="apply" class="form-label"><input type="file" name="imageFile" id="apply" accept="image/*,.pdf"></label>
                            <input type="hidden" id="imageFileb64" name="imageFileb64">
                            <input type="hidden" id="reservation_id" name="reservation_id" value="">
                    </div>
                   
                    <br>
                    <br>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary"  >Submit</button>
               <button type="button" class="btn btn-default" data-dismiss="modal" >Cancel</button>
              </div>
            </div>
          </div>
          </div>
        </div>
        </div>
  </form> 


  <!-- MODAL -->
  <form action="/dashboard/user/rentals/ongoing" method="post">
    <div class="modal fade" id="updateConfirmModal" tabindex="-1" aria-labelledby="updateConfirmModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateConfirmModalLabel">UPDATE STATUS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            You are about to update the status for order number <span id="orderNum" value=""></span>. Proceed?
            <input type="hidden" name="buttonVal" id="buttonValModal" value="">
            <input type="hidden" name="orderId" id="reservationIdHidden" value="">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
            <button type="submit" class="btn btn-primary">Yes</button>
          </div>
        </div>
      </div>
    </div>      
  </form>

  <!-- EXTENSION MODAL -->
  <form action="/dashboard/user/rentals/ongoing/extension" method="post">
    <div class="modal fade" id="applyExtensionModal" tabindex="-1" aria-labelledby="applyExtensionModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="applyExtensionModalLabel">APPLYING FOR EXTENSION</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Rental ID Number: <span id="orderNumExtension" value=""></span><br>
            Input the number of days to extend the rental: <input type="number" name="numDays" min="1" max="5" value="1" required> <br><br>
            NOTE: It will only be requested if there is no existing reservation for that date.
            <input type="hidden" name="inventoryId" id="inventoryId" value="">
            <input type="hidden" name="orderIdExtension" id="orderIdExtension" value="">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
            <button type="submit" class="btn btn-primary">Request</button>
          </div>
        </div>
      </div>
    </div>      
  </form>

	<script src="/assets/scripts/dashboard_orders.js"></script>
</body>

<script>

    document.querySelector("#apply").addEventListener("change", readFile);
    function readFile() { 
      if (!this.files || !this.files[0]) return;         
      const FR = new FileReader();
         
      FR.addEventListener("load", function(evt) {
         document.querySelector("#imageFileb64").value = evt.target.result;
      });          
      FR.readAsDataURL(this.files[0]);      
      }

      function showModal(reserve_id ,reservation_start, reservation_end, item_name, quantity, rental_rate, deposit_fee, total_fee){
        document.getElementById("gResStart").innerHTML = reservation_start;
        document.getElementById("gResEnd").innerHTML =reservation_end;
        document.getElementById("gQuantity").innerHTML = quantity;
        document.getElementById("gRental").innerHTML =rental_rate;
        document.getElementById("gReplacement").innerHTML =deposit_fee;
        document.getElementById("gItemName").innerHTML =item_name;
        document.getElementById("gTotal").innerHTML = total_fee;

        document.getElementById("reservation_id").setAttribute("value", reserve_id);
        }


  function updateBtnFunc(num){
        buttonValModal = document.getElementById("buttonValModal");
        buttonVal = document.getElementById("buttonVal");
        status = buttonVal.value
        buttonValModal.setAttribute("value", status);
        console.log(status)

        orderNum = document.getElementById("orderNum");
        orderNum.textContent = num;

        reservationId = document.getElementById("reservationIdHidden");
        reservationId.setAttribute("value", num);
    }

    function applyExtensionFunc(num, invenId){
      orderId = document.getElementById("orderIdExtension");
      orderIdSpan = document.getElementById("orderNumExtension");
      inventoryId = document.getElementById("inventoryId")

      orderIdSpan.textContent = num;
      orderId.setAttribute("value", num);
      inventoryId.setAttribute("value", invenId);
    }
</script>
</html>
